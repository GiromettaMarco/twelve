#!/usr/bin/env php
<?php

// Coverage value
$coverage = 0;

// Initialize the XML parser
$parser = xml_parser_create();

// Become true once coverage has been collected
$collected = false;

// Specify element handler
xml_set_element_handler(
    $parser,
    function ($parser, $element_name, $element_attrs) use (&$collected, &$coverage) {
        // Find the element
        if (!$collected && $element_name === 'LINES') {
            // Collect coverage
            $coverage = intval($element_attrs['PERCENT']);

            // Stop reading
            $collected = true;
        }
    },
    null
);

// Open XML file
$fp = fopen("reports/phpunit/index.xml", "r");

// Read data and exit when METRICS is found.
// We expect to find it in the first kilobyte.
while (!$collected && $data = fread($fp, 1024)) {
    xml_parse($parser, $data, feof($fp)) or
        die(sprintf(
            "XML Error: %s at line %d",
            xml_error_string(xml_get_error_code($parser)),
            xml_get_current_line_number($parser)
        ));
}

// Free the XML parser
xml_parser_free($parser);

// Set badge color
if ($coverage < 60) {
    $color_1 = '#e05d44';
    $color_2 = '#8f250f';
} elseif ($coverage < 90) {
    $color_1 = '#ffd53d';
    $color_2 = '#b99614';
} else {
    $color_1 = '#34d058';
    $color_2 = '#28a745';
}

// Write the badge in output buffer
ob_start();
?>
<svg xmlns="http://www.w3.org/2000/svg" width="114" height="20">
    <title>Coverage - <?php echo $coverage; ?>%</title>
    <defs>
        <linearGradient id="workflow-fill" x1="50%" y1="0%" x2="50%" y2="100%">
            <stop stop-color="#444D56" offset="0%" />
            <stop stop-color="#24292E" offset="100%" />
        </linearGradient>
        <linearGradient id="state-fill" x1="50%" y1="0%" x2="50%" y2="100%">
            <stop stop-color="<?php echo $color_1; ?>" offset="0%" />
            <stop stop-color="<?php echo $color_2; ?>" offset="100%" />
        </linearGradient>
    </defs>
    <g>
        <rect rx="3" width="114" height="20" fill="url(#workflow-fill)" />
        <rect rx="3" x="79" width="35" height="20" fill="url(#state-fill)" />
        <path fill="url(#state-fill)" d="M79 0h4v20h-4z" />
        <rect rx="3" width="116" height="20" fill="url(#a)" />
        <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
            <text x="49" y="15" fill="#010101" fill-opacity=".3" aria-hidden="true">coverage</text>
            <text x="49" y="14">coverage</text>
            <text x="97" y="15" fill="#010101" fill-opacity=".3" aria-hidden="true"><?php echo $coverage; ?>%</text>
            <text x="97" y="14"><?php echo $coverage; ?>%</text>
        </g>
        <image x="5" y="3" width="14" height="14"
            href="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjNzc3QkI0IiByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+UEhQPC90aXRsZT48cGF0aCBkPSJNNy4wMSAxMC4yMDdoLS45NDRsLS41MTUgMi42NDhoLjgzOGMuNTU2IDAgLjk3LS4xMDUgMS4yNDItLjMxNC4yNzItLjIxLjQ1NS0uNTU5LjU1LTEuMDQ5LjA5Mi0uNDcuMDUtLjgwMi0uMTI0LS45OTUtLjE3NS0uMTkzLS41MjMtLjI5LTEuMDQ3LS4yOXpNMTIgNS42ODhDNS4zNzMgNS42ODggMCA4LjUxNCAwIDEyczUuMzczIDYuMzEzIDEyIDYuMzEzUzI0IDE1LjQ4NiAyNCAxMmMwLTMuNDg2LTUuMzczLTYuMzEyLTEyLTYuMzEyem0tMy4yNiA3LjQ1MWMtLjI2MS4yNS0uNTc1LjQzOC0uOTE3LjU1MS0uMzM2LjEwOC0uNzY1LjE2NC0xLjI4NS4xNjRINS4zNTdsLS4zMjcgMS42ODFIMy42NTJsMS4yMy02LjMyNmgyLjY1Yy43OTcgMCAxLjM3OC4yMDkgMS43NDQuNjI4LjM2Ni40MTguNDc2IDEuMDAyLjMzIDEuNzUyYTIuODM2IDIuODM2IDAgMCAxLS4zMDUuODQ3Yy0uMTQzLjI1NS0uMzMuNDktLjU2MS43MDN6bTQuMDI0LjcxNWwuNTQzLTIuNzk5Yy4wNjMtLjMxOC4wMzktLjUzNi0uMDY4LS42NTEtLjEwNy0uMTE2LS4zMzYtLjE3NC0uNjg3LS4xNzRIMTEuNDZsLS43MDQgMy42MjVIOS4zODhsMS4yMy02LjMyN2gxLjM2N2wtLjMyNyAxLjY4MmgxLjIxOGMuNzY3IDAgMS4yOTUuMTM0IDEuNTg2LjQwMXMuMzc4LjcuMjYzIDEuMjk5bC0uNTcyIDIuOTQ0aC0xLjM4OXptNy41OTctMi4yNjVhMi43ODIgMi43ODIgMCAwIDEtLjMwNS44NDdjLS4xNDMuMjU1LS4zMy40OS0uNTYxLjcwM2EyLjQ0IDIuNDQgMCAwIDEtLjkxNy41NTFjLS4zMzYuMTA4LS43NjUuMTY0LTEuMjg2LjE2NGgtMS4xOGwtLjMyNyAxLjY4MmgtMS4zNzhsMS4yMy02LjMyNmgyLjY0OWMuNzk3IDAgMS4zNzguMjA5IDEuNzQ0LjYyOC4zNjYuNDE3LjQ3NyAxLjAwMS4zMzEgMS43NTF6TTE3Ljc2NiAxMC4yMDdoLS45NDNsLS41MTYgMi42NDhoLjgzOGMuNTU3IDAgLjk3MS0uMTA1IDEuMjQyLS4zMTQuMjcyLS4yMS40NTUtLjU1OS41NTEtMS4wNDkuMDkyLS40Ny4wNDktLjgwMi0uMTI1LS45OTVzLS41MjQtLjI5LTEuMDQ3LS4yOXoiLz48L3N2Zz4=" />
    </g>
</svg>

<?php
// Make docs dir if missing
if (!is_dir('docs')) {
    mkdir('docs');
}

// Make the badge file
file_put_contents('docs/php-coverage.svg', ob_get_contents());

// Close the output buffer
ob_end_clean();
